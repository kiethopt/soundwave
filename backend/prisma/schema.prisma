generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  username             String?   @unique
  password             String
  name                 String?
  avatar               String?
  role                 Role      @default(USER)
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  lastLoginAt          DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Relations
  artistProfile ArtistProfile?
  history       History[]
  playlists     Playlist[]
  followed      UserFollow[]    @relation("Follower") // Người dùng này theo dõi người khác
  followers     UserFollow[]    @relation("FollowingUser") // Người dùng này được người khác theo dõi
  notifications Notification[]  @relation("UserNotifications") // Thông báo mà người dùng nhận được
  likedTracks   UserLikeTrack[]

  @@unique([email, username])
  @@index([email])
  @@index([username])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model ArtistProfile {
  id                      String    @id @default(cuid())
  artistName              String    @unique
  bio                     String?   @db.Text
  avatar                  String?
  socialMediaLinks        Json?
  monthlyListeners        Int       @default(0) @db.Integer
  isVerified              Boolean   @default(false)
  verificationRequestedAt DateTime?
  verifiedAt              DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Quan hệ one-to-one với User
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Relations liên quan đến nghệ sĩ
  genres        ArtistGenre[]
  albums        Album[]
  tracks        Track[]
  events        Event[]
  TrackArtist   TrackArtist[]
  followers     UserFollow[]   @relation("FollowingArtist") // Người dùng theo dõi nghệ sĩ
  notifications Notification[] @relation("ArtistNotifications") // Thông báo mà artist nhận được

  @@index([artistName])
  @@index([isVerified])
  @@index([verifiedAt])
  @@map("artist_profiles")
}

model ArtistGenre {
  id              String   @id @default(cuid())
  artistProfileId String
  genreId         String
  createdAt       DateTime @default(now())

  // Quan hệ many-to-one với ArtistProfile
  artistProfile ArtistProfile @relation(fields: [artistProfileId], references: [id], onDelete: Cascade)

  // Quan hệ many-to-one với Genre
  genre Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@unique([artistProfileId, genreId])
  @@map("artist_genre")
}

model Album {
  id          String    @id @default(cuid())
  title       String
  coverUrl    String?
  releaseDate DateTime
  duration    Int       @default(0) @db.Integer
  totalTracks Int       @default(0) @db.Integer
  type        AlbumType @default(ALBUM)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  artist   ArtistProfile @relation(fields: [artistId], references: [id], onDelete: Cascade)
  artistId String
  tracks   Track[]
  genres   AlbumGenre[]

  @@unique([title, artistId])
  @@index([title])
  @@index([artistId])
  @@index([releaseDate])
  @@index([isActive])
  @@index([createdAt])
  @@map("albums")
}

model Track {
  id          String    @id @default(cuid())
  title       String
  duration    Int       @default(0) @db.Integer
  releaseDate DateTime
  trackNumber Int?      @db.Integer
  coverUrl    String?
  audioUrl    String
  playCount   Int       @default(0) @db.Integer
  type        AlbumType @default(SINGLE)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  artist          ArtistProfile   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  artistId        String
  featuredArtists TrackArtist[]
  album           Album?          @relation(fields: [albumId], references: [id], onDelete: Cascade)
  albumId         String?
  genres          TrackGenre[]
  playlists       PlaylistTrack[]
  history         History[]
  likedBy         UserLikeTrack[]

  @@unique([title, artistId])
  @@index([title])
  @@index([artistId])
  @@index([albumId])
  @@index([playCount])
  @@index([releaseDate])
  @@index([isActive])
  @@index([createdAt])
  @@map("tracks")
}

model History {
  id        String      @id @default(cuid())
  type      HistoryType
  query     String?
  duration  Int?        @db.Integer
  completed Boolean?
  playCount Int?        @db.Integer
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  track   Track?  @relation(fields: [trackId], references: [id], onDelete: Cascade)
  trackId String?
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String

  @@unique([userId, trackId, type])
  @@index([userId])
  @@index([type])
  @@index([trackId])
  @@index([createdAt])
  @@index([playCount])
  @@map("histories")
}

model Playlist {
  id            String          @id @default(cuid())
  name          String
  description   String?
  coverUrl      String?
  privacy       PlaylistPrivacy @default(PRIVATE)
  type          PlaylistType    @default(NORMAL)
  isAIGenerated Boolean         @default(false)
  totalTracks   Int             @default(0) @db.Integer
  totalDuration Int             @default(0) @db.Integer
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  tracks PlaylistTrack[]

  @@unique([userId, type])
  @@unique([name, userId])
  @@index([userId])
  @@index([privacy])
  @@map("playlists")
}

model Genre {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  albums         AlbumGenre[]
  tracks         TrackGenre[]
  artistProfiles ArtistGenre[]

  @@index([name])
  @@map("genres")
}

/**
 * Trong quan hệ user, tên ràng buộc được đặt là "notifications_user_recipientId_fkey".
 * Trong quan hệ artist, tên ràng buộc được đặt là "notifications_artist_recipientId_fkey".
 */

model Notification {
  id            String           @id @default(cuid())
  type          NotificationType
  message       String
  isRead        Boolean          @default(false)
  recipientType RecipientType
  userId        String? // ID của User (nếu recipient là USER)
  artistId      String? // ID của ArtistProfile (nếu recipient là ARTIST)
  senderId      String?
  count         Int?             @default(1)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Quan hệ với User
  user User? @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  // Quan hệ với ArtistProfile
  artist ArtistProfile? @relation("ArtistNotifications", fields: [artistId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([artistId])
  @@index([senderId])
  @@index([createdAt])
  @@map("notifications")
}

model Event {
  id          String   @id @default(cuid())
  title       String
  description String?
  location    String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  artist   ArtistProfile @relation(fields: [artistId], references: [id], onDelete: Cascade)
  artistId String

  @@unique([title, artistId])
  @@index([artistId])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@index([createdAt])
  @@map("events")
}

// Bảng trung gian

model UserFollow {
  id                String        @id @default(cuid())
  followerId        String
  followingUserId   String? // Tham chiếu đến User.id khi followingType là USER
  followingArtistId String? // Tham chiếu đến ArtistProfile.id khi followingType là ARTIST
  followingType     FollowingType
  createdAt         DateTime      @default(now())

  // Quan hệ với User (người theo dõi)
  follower User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)

  // Quan hệ với User (nếu followingType là USER)
  followingUser User? @relation("FollowingUser", fields: [followingUserId], references: [id], onDelete: Cascade)

  // Quan hệ với ArtistProfile (nếu followingType là ARTIST)
  followingArtist ArtistProfile? @relation("FollowingArtist", fields: [followingArtistId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingUserId, followingType])
  @@unique([followerId, followingArtistId, followingType])
  @@index([followerId])
  @@index([followingUserId])
  @@index([followingArtistId])
  @@map("user_follow")
}

model AlbumGenre {
  id        String   @id @default(cuid())
  albumId   String
  genreId   String
  createdAt DateTime @default(now())

  album Album @relation(fields: [albumId], references: [id], onDelete: Cascade)
  genre Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@unique([albumId, genreId])
  @@index([albumId])
  @@index([genreId])
  @@map("album_genre")
}

model TrackGenre {
  id        String   @id @default(cuid())
  trackId   String
  genreId   String
  createdAt DateTime @default(now())

  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)
  genre Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@unique([trackId, genreId])
  @@index([trackId])
  @@index([genreId])
  @@map("track_genre")
}

model TrackArtist {
  id              String   @id @default(cuid())
  trackId         String
  artistProfileId String
  createdAt       DateTime @default(now())

  track         Track         @relation(fields: [trackId], references: [id], onDelete: Cascade)
  artistProfile ArtistProfile @relation(fields: [artistProfileId], references: [id], onDelete: Cascade)

  @@unique([trackId, artistProfileId])
  @@index([trackId])
  @@index([artistProfileId])
  @@map("track_artist")
}

model PlaylistTrack {
  id         String   @id @default(cuid())
  playlistId String
  trackId    String
  addedAt    DateTime @default(now())
  trackOrder Int      @db.Integer

  // Relations
  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  track    Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([playlistId, trackId])
  @@index([playlistId])
  @@index([trackId])
  @@map("playlist_track")
}

model UserLikeTrack {
  id        String   @id @default(cuid())
  userId    String
  trackId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([userId, trackId])
  @@index([userId])
  @@index([trackId])
  @@map("user_like_track")
}

enum Role {
  USER
  ARTIST
  ADMIN
}

enum AlbumType {
  ALBUM
  EP
  SINGLE
}

enum HistoryType {
  SEARCH
  PLAY
}

enum PlaylistPrivacy {
  PUBLIC
  PRIVATE
}

enum PlaylistType {
  FAVORITE
  NORMAL
}

enum NotificationType {
  NEW_TRACK // Artist phát hành track mới
  NEW_ALBUM // Artist phát hành album mới
  EVENT_REMINDER // Nhắc nhở về sự kiện
  NEW_FOLLOW // Thông báo có người follow (dùng cho cả user và artist)
}

enum FollowingType {
  USER
  ARTIST
}

enum RecipientType {
  USER
  ARTIST
}
